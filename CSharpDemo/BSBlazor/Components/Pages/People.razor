@page "/people"
@rendermode InteractiveServer
@using BootstrapBlazor.Components

<h4 class="mb-3">人员管理</h4>

<!-- 工具栏 -->
<div class="d-flex gap-2 mb-2">
    <Button Color="Color.Primary" OnClick="NewPerson">
        <i class="bi bi-plus-lg me-1"></i> 新增
    </Button>

    <Button Color="Color.Danger" Disabled="@(!Selected.Any())" OnClick="DeleteSelected">
        <i class="bi bi-trash me-1"></i> 删除所选 (@Selected.Count)
    </Button>
</div>

<!-- 表格 -->
<Table TItem="Person"
       Items="Models"
       IsStriped="true"
       IsBordered="true">

    <TableColumns>
        <TableColumn Field="@nameof(Person.Id)">编号</TableColumn>
        <TableColumn Field="@nameof(Person.Name)">姓名</TableColumn>
        <TableColumn Field="@nameof(Person.Age)">年龄</TableColumn>

    </TableColumns>
</Table>


@* <Badge Color="Color.Info" Class="mt-2">
    说明：本示例使用内存集合作为数据源，实际项目中可结合数据库等持久化存储。
</Badge> *@

<!-- 编辑面板（新增/编辑共用） -->
@if (IsEditorOpen)
{
    <div class="card mt-3">
        <div class="card-header">
            <strong>@(Editing.Id == 0 ? "新增人员" : $"编辑人员 - #{Editing.Id}")</strong>
        </div>
        <div class="card-body">
            <EditForm Model="Editing" OnValidSubmit="Save">
                <DataAnnotationsValidator />
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">姓名</label>
                        <InputText class="form-control" @bind-Value="Editing.Name" />
                        <ValidationMessage For="() => Editing.Name" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">年龄</label>
                        <InputNumber class="form-control" @bind-Value="Editing.Age" />
                        <ValidationMessage For="() => Editing.Age" />
                    </div>
                </div>

                <div class="mt-3 d-flex gap-2">
                    <Button Color="Color.Primary" ButtonType="ButtonType.Submit">
                        保存
                    </Button>
                    <Button Color="Color.Light" OnClick="CancelEdit">
                        取消
                    </Button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    // ===== 内存数据源 =====
    private List<Person> Models { get; set; } =
    [
        new() { Id = 1, Name = "张三", Age = 18 },
        new() { Id = 2, Name = "李四", Age = 20 },
        new() { Id = 3, Name = "王五", Age = 22 }
    ];

    // 表格多选
    private List<Person> Selected { get; set; } = [];

    // 编辑状态
    private bool IsEditorOpen { get; set; }
    private Person Editing { get; set; } = new();

    // ===== 新增 =====
    private void NewPerson()
    {
        Editing = new Person(); // Id=0 代表新增
        IsEditorOpen = true;
    }

    // ===== 编辑 =====
    private void BeginEdit(Person src)
    {
        // 复制一份，避免在保存前“预览修改”影响列表
        Editing = new Person
        {
            Id = src.Id,
            Name = src.Name,
            Age = src.Age
        };
        IsEditorOpen = true;
    }

    // ===== 保存（新增/编辑公用） =====
    private void Save()
    {
        if (Editing.Id == 0)
        {
            // 新增：生成新 Id
            var newId = Models.Count == 0 ? 1 : Models.Max(p => p.Id) + 1;
            Editing.Id = newId;
            Models.Add(Editing);
        }
        else
        {
            // 编辑：覆盖原对象
            var idx = Models.FindIndex(p => p.Id == Editing.Id);
            if (idx >= 0) Models[idx] = Editing;
        }

        IsEditorOpen = false;
        Editing = new Person();
    }

    private void CancelEdit()
    {
        IsEditorOpen = false;
        Editing = new Person();
    }

    // ===== 删除（单条） =====
    private void DeleteOne(Person p)
    {
        Models.Remove(p);
        Selected.Remove(p);
    }

    // ===== 删除（批量） =====
    private void DeleteSelected()
    {
        if (Selected.Count == 0) return;
        foreach (var p in Selected.ToList())
        {
            Models.Remove(p);
        }
        Selected.Clear();
    }

    // ===== 模型 =====
    public class Person
    {
        public int Id { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "姓名必填")]
        [System.ComponentModel.DataAnnotations.StringLength(32, ErrorMessage = "姓名过长")]
        public string? Name { get; set; }

        [System.ComponentModel.DataAnnotations.Range(1, 120, ErrorMessage = "年龄需在 1-120 之间")]
        public int Age { get; set; }
    }
}